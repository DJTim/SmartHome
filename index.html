<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="slider.css">
	<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
	<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
	<script src="jquery.ui.touch-punch.min.js"></script>
  	<script type="text/javascript">
  	
  	var room = "";
  	
  	function updateGUI(data, initGUI){
  		if (data['_id'] == room){
			$.each(data['lights'], function( index, value ) {
				if (initGUI){
					$("#btn_"+index).attr("id",value['name']);
				}
			
				idName = "#"+value['name'];
			
				switch(value['type']){
					case 'switch':
						if (value['state']=='off'){
							$(idName).css( "background-color", "#797979" );
							$(idName).attr("onclick","domo_switch('"+value['name']+"','on')");
						}else{
							$(idName).css( "background-color", "#454545" );
							$(idName).attr("onclick","domo_switch('"+value['name']+"','off')");
						}
					break;
					case 'dim':
						if (initGUI){
							$(idName).slider({
								orientation: "vertical",
								range: "min",
								min: 0,
								max: 15,
								value: value['state'],
								slide: function( event, ui ) {
									domo_switch(value['name'],ui.value);
								}
							});
						}else{
							$(idName).slider("value", value['state']);
						}
					break;
				}
			});
		}
	}
	
	function domo_switch(id, state){
		$.ajax({
		  type: "PUT",
		  url: "http://192.168.2.215:8080/api/" + room + "/"+id,
		  data: '{"state": "'+state+'"}',
		  dataType: "json"
		});
	}
	
	function updateGUIPoll() {
        var poll_interval=0;

        $.ajax({
                url: "http://192.168.2.215:8080/api/rooms/listen",
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                        updateGUI(data, false);
                        poll_interval=0;
                },
                error: function () {
                        poll_interval=1000;
                },
                complete: function () {
                        setTimeout(updateGUIPoll, poll_interval);
                },
        });
	}
	
	function getParam(val) {
		var result = "Not found",
			tmp = [];
		location.search
		.substr(1)
			.split("&")
			.forEach(function (item) {
			tmp = item.split("=");
			if (tmp[0] === val) result = decodeURIComponent(tmp[1]);
		});
		return result;
	}
	
	$(function() {
		room = getParam("room");
		
		if (room == "Not found"){
			alert("No room specified in url");
			return;
		}
		
		//initial update of GUI
		$.get( "http://192.168.2.215:8080/api/rooms/" + room, function(data) {
			updateGUI(data, true);
        });
		
		//start long polling to server
		updateGUIPoll();
	})
	</script>
<style>
* {
   margin: 0px;
   padding: 0px;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    /*cursor: none;*/ 
}
body {
    overflow:hidden;
}
.page{
	font-family: "Helvetica Neue";
	font-weight: lighter;
	color: #bebebe;
}
.row{
	width: 320px;
}
.cellHeadLeft{
	width: 160px;
	height: 70px;
	background-color: #000;
	float: left;
	font-size: 60px;
}
.cellHeadRight{
	width: 160px;
	height: 70px;
	background-color: #454545;
	float: right;
	font-size: 21px;
}
.alignMiddle{
	margin-top: 10px;
	margin-left: 5px;
	margin-bottom: 10px;
}
.cellLeft{
	width: 160px;
	height: 170px;
	/*background-color: #797979;*/
	float: left;
	text-align: center;
	font-size: 30px;
}
.cellRight{
	width: 160px;
	height: 170px;
	/*background-color: #797979;*/
	float: right;
	text-align: center;
	font-size: 30px;
}
.alignCenter{
	margin-top: 70px;
}
</style>
</head>
<body>
<div class="page">
	<div class="row">
		<div class="cellHeadLeft">
		15:00
		</div>
		<div class="cellHeadRight">
			<div class="alignMiddle">
				Friday <br>
				December 26
			</div>
		</div>
	</div>
	<div class="row">
		<div id="btn_0" class="cellLeft"></div>
		<div id="btn_1" class="cellRight"></div>
	</div>
</div>

</body>
</html>